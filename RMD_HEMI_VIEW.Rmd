---
title: "ExploringHemi"
output: html_document
date: "2023-08-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

library(tidyverse)

```

```{r}
test <- read.csv("C:/Users/gn238/OneDrive - Mississippi State University/hemispherical_photos/XLSCanopy_T1.csv")
test2 <- read.csv("C:/Users/gn238/OneDrive - Mississippi State University/hemispherical_photos/PIC_A_NO_E_CSV.csv")



colnames_data <- c("Photo#", "FileName", "Analysis Date Time", "Acquisition Date Time", 
  "Modified Date Time", "ImageSize H V PxSizeH PxSizeV", "Edited Sharpened ChromAberRemoval_RGB", 
  "Camera Make Model Software", "LensFocLength [Equiv. 35mm]", 
  "Aperture", "ExposureTime", "Camera ISO Metering", "Camera Exposure Prog. Bias Mode", 
  "Camera Gain Contrast Saturation Sharpness", "UserCameraModel-SN LensModel-SN", 
  "FOVMax", "LensType LensCalCoef[0 to 9]", "HemiRadiusCentreHV/CoverExtCoef", 
  "GapSizeDist Method Params", "Bonhom ViewAng Span", "LAI2000 NRing PathLengthSubs", 
  "LAISphereProjCoef LAIUsedForG(z)", "NSky NZen NOrien[Orig] ZenMin ZenMax DifRadModel", 
  "GapFrZeroSubs PxOrGap", "ZenithRingsRange", "NofMask", "RadiationUnits", 
  "TimeZone", "MinutesInterval", "GrowSeasActive Begin End DayInt", 
  "SubstDirRad DiffRad", "Index[NDVI] Definition", "Index[NDVI]Total", 
  "Index[NDVI]Avg", "Index[NDVI]Min", "Index[NDVI]Max", NA, NA, 
  NA, "SolarConstant PARToRadRatio DiffRadToDirRadRatio AtmTrans SunSizeMeth", 
  "Channel NBits", "PxClassifMeth PxClassifModif", "FieldTripDate", 
  "FieldTripSite", "FieldTripOpAssist", "AcquisitionTime", "MemoryCard", 
  "CameraHeight", "Plot", "SkyCond", "Analyst", "Comment", "Slope Aspect", 
  "NorthRef Declination[Negative=W]", "Orientation", "Latitude[<0=S]", 
  "Longitude[<0=W]", "Altitude", "CrownProjArea(CPA)", "GapFraction", 
  "Openness", "LAI(Bonhom)-Lin", "LAI(2000)-Lin", "LAI(2000G)-Lin", 
  "LAI(Sphere)-Lin", "LAI(Ellips)-Lin", "MeanLeafAngle-Lin", "LAI(Bonhom)-Log", 
  "LAI(2000)-Log", "LAI(2000G)-Log", "LAI(Sphere)-Log", "LAI(Ellips)-Log", 
  "MeanLeafAngle-Log", "NofZeroGapFrRgn", "CI(Bonhom)", "CI(2000)", 
  "CI(2000G)", "CI(Sphere)", "CI(Ellips)", "CI(GSD)", "CrownCoverRatio", 
  "FoliageCoverRatio", "CrownPorosity", "LAIAtZenViewAngle", "LAIBeerLambert", 
  "LAI(Bonhom)-Lin CICorr", "LAI(2000)-Lin CICorr", "LAI(2000G)-Lin CICorr", 
  "LAI(Sphere)-Lin CICorr", "LAI(Ellips)-Lin CICorr", "LAI(Bonhom)-Log CICorr", 
  "LAI(2000)-Log CICorr", "LAI(2000G)-Log CICorr", "LAI(Sphere)-Log CICorr", 
  "LAI(Ellips)-Log CICorr", "SilhouetteArea(SA)/FoliageA", "CrownArea(CA)/TotGapA", 
  "FrameArea(PFA)/ImageA", "LAI IsolTree/FoliageCover", "DirectSiteFactor",
  "IndirectSiteFactor", "TotalSiteFactor", "PPFDDirectOverPerDay[MJorMol/m2day]", 
  "PPFDDiffuseOverPerDay[MJorMol/m2day]", "PPFDTotalOverPerDay[MJorMol/m2day]", 
  "PPFDDirectUnderPerDay[MJorMol/m2day]", "PPFDDiffuseUnderPerDay[MJorMol/m2day]", 
  "PPFDTotalUnderPerDay[MJorMol/m2day]", "GapRgnArea", "GapRgnZen", 
  "GapRgnAz", "GapRgnHeight", "GapRgnGapFrac", "GapRgnDirRadOver", 
  "GapRgnDirRadUnder", "GapRgnDifRadOver", "GapRgnDifRadUnder", 
  "...")

data <- read_csv("C:/Users/gn238/OneDrive - Mississippi State University/hemispherical_photos/XLSCanopy_T1.csv", skip = 6, col_names = colnames_data)

data2 <- read_csv("C:/Users/gn238/OneDrive - Mississippi State University/hemispherical_photos/PIC_A_NO_E_CSV.csv", skip = 6, col_names = colnames_data)

```

```{r "optional install section"}

install.packages("sf")
install.packages("janitor")

```

```{r "importing data and packages and a little cleaning"}
library('tidyverse')

library(sf)

library(janitor)

# this is for the jones center #       setwd("R:/graduate_students/Nyen/R - Copy/r_pull_from")
setwd("C:/Users/gn238/OneDrive - Mississippi State University/R - Copy/r_pull_from")

regendatarmd <- read.csv("C:/Users/gn238/OneDrive - Mississippi State University/R - Copy/r_pull_from/regenplots.csv")
#clean the data #take off the quadrat numbers and pool into sampling pints
  
regendatarmd <- regendatarmd   %>% 
  separate(col = PLOT_ID,  into = c("stand", "transect", "position")) %>% 
  janitor::clean_names()

regendatarmd$standbyrow <- paste(regendatarmd$stand, "_", regendatarmd$row)

new_summary <- regendatarmd %>% 
  group_by(stand, transect, position, row, quadrat) %>% 
  summarise(n_seedlings  = length(position[regen_count>=1]),
            mean_height = mean(height_cm))

poolposition <- new_summary <- regendatarmd %>% 
  group_by(stand, transect, position, row) %>% 
  summarise(n_seedlings  = length(position[regen_count>=1]),
            mean_height = mean(height_cm))


```

```{r "do the same seperation of collums for stands for the canopy stuff"}
hemidata <- data2 %>% 
  separate(col = Plot, into = c("stand", "transect", "position")) %>% 
  janitor::clean_names()

hemidata <- hemidata %>%  
    mutate(stand = as.numeric(stand))
hemidata <- hemidata %>%  
    mutate(transect = as.numeric(transect))
hemidata <- hemidata %>%  
    mutate(position = as.character(position))



regendatarmd <- regendatarmd %>%  
    mutate(stand = as.numeric(stand))
regendatarmd <- regendatarmd %>%  
    mutate(transect = as.numeric(transect))
regendatarmd <- regendatarmd %>%  
    mutate(position = as.character(position))


new_summary <- new_summary %>%  
    mutate(stand = as.numeric(stand))
new_summary <- new_summary %>%  
    mutate(transect = as.numeric(transect))
new_summary <- new_summary %>%  
    mutate(position = as.character(position))

poolposition <- poolposition %>%  
    mutate(stand = as.numeric(stand))
poolposition <- poolposition %>%  
    mutate(transect = as.numeric(transect))
poolposition <- poolposition %>%  
    mutate(position = as.character(position))




```



```{r "make some summary tables of the hemidata}
bigdat <- new_summary %>% full_join(hemidata, by = c("stand", "transect", "position"))
pooldat <- poolposition %>% full_join(hemidata, by = c("stand", "transect", "position"))

poolsum <- pooldat %>% 
  group_by(stand, transect, position) %>% 
    reframe(n_seedlings, mean_height, gap_fraction, openness, lai_2000_lin , ppfd_total_under_per_day_m_jor_mol_m2day )


hemisum <- bigdat %>% 
  group_by(stand, transect, position) %>% 
    reframe(n_seedlings, mean_height, gap_fraction, openness, lai_2000_lin , ppfd_total_under_per_day_m_jor_mol_m2day )


histdata <- hemisum %>% 
  group_by(stand, transect, position) %>% 
    reframe(hemisum[which(hemisum$n_seedlings>0),], mean_height, gap_fraction, openness, lai_2000_lin , ppfd_total_under_per_day_m_jor_mol_m2day )

```



```{r "lets get grapphy"}

ggplot(hemisum[which(hemisum$n_seedlings>0),],aes(ppfd_total_under_per_day_m_jor_mol_m2day, n_seedlings))+
  geom_point() +
    geom_smooth(method = "lm", se=F)
    
ggplot(hemisum[which(hemisum$n_seedlings>0),],aes(ppfd_total_under_per_day_m_jor_mol_m2day, n_seedlings))+
  geom_point() +
    geom_smooth(se=F)      

ggplot(hemisum[which(hemisum$n_seedlings>0),],aes(gap_fraction, n_seedlings))+
  geom_point() +
    geom_smooth(se=F)


ggplot(hemisum[which(hemisum$n_seedlings>0),],aes(gap_fraction, n_seedlings))+
  geom_point() +
    geom_smooth(method = "lm", se=F)

ggplot(hemisum[which(hemisum$n_seedlings>0),],aes(openness, n_seedlings))+
  geom_point() +
    geom_smooth(se=F)

ggplot(hemisum[which(hemisum$n_seedlings>0),],aes(openness, n_seedlings))+
  geom_point() +
    geom_smooth(method = "lm", se=F)

ggplot(hemisum[which(hemisum$n_seedlings>0),],aes(lai_2000_lin, n_seedlings))+
  geom_point() +
    geom_smooth(se=F)

```
```{r}

ggplot(hemisum, aes(ppfd_total_under_per_day_m_jor_mol_m2day, mean_height))+
  geom_point() +
    geom_smooth(method = "lm", se=F)
    
ggplot(hemisum, aes(ppfd_total_under_per_day_m_jor_mol_m2day, mean_height))+
  geom_point() +
    geom_smooth(se=F)      

ggplot(hemisum[which(hemisum$mean_height>0),], aes(gap_fraction, mean_height))+
  geom_point() +
    geom_smooth(se=F)

#bad dont use
ggplot(hemisum[which(hemisum$n_seedlings>0),], aes(gap_fraction, mean_height))+
  geom_point() +
    geom_smooth(method = "lm", se=F)

#also bad?
ggplot(hemisum[which(hemisum$n_seedlings>0),], aes(openness, mean_height))+
  geom_point() +
    geom_smooth(method = "lm", se=F)


ggplot(hemisum[which(hemisum$n_seedlings>0),], aes(openness, mean_height))+
  geom_point() +
    geom_smooth(se=F)

ggplot(hemisum[which(hemisum$n_seedlings>0),], aes(lai_2000_lin, mean_height))+
  geom_point() +
    geom_smooth(method = "lm", se=F)

ggplot(hemisum[which(hemisum$n_seedlings>0),], aes(lai_2000_lin, mean_height))+
  geom_point() +
    geom_smooth(se=F)

```

```{r "how about some occurance histograms"}

ggplot(poolsum, aes(x=openness)) +
    geom_histogram(bins=10)
    
ggplot(poolsum[which(hemisum$n_seedlings>0),], aes(x=openness)) +
    geom_histogram(bins=25)



```
```{r "Started to use Poisson GLM distributions?"}
# Dpark is x -- n_seedlings
#TotN is y -- Openness

plot(poolsum$openness, poolsum$n_seedlings, xlab ="Number of Seedlings", ylab = "Canopy Openness")

M1 <- glm(n_seedlings ~ openness, family = poisson, data = poolsum)
poolsum %>% glm(formula = openness ~ n_seedlings, family = poisson)
summary(M1)

explanatory_data <- poolsum %>% 
    select(openness)

predict(M1, explanatory_data)

residuals(M1)

GEX <- predict(M1, newdata = explanatory_data, type = "link", se= T)
FEX <- exp(GEX$fit)
FSEUP <- exp(GEX$fit + 1.96 * GEX$se.fit)
FSELOW <- exp(GEX$fit - 1.96 * GEX$se.fit)
lines(explanatory_data$openness, FEX, lty=1)





plot(poolsum$openness, poolsum$n_seedlings, xlab ="Number of Seedlings", ylab = "Canopy Openness") +
lines(explanatory_data$openness, FEX, lty=1) +
lines(explanatory_data$openness, FSEUP, lty = 2) +
  lines(explanatory_data$openness, FSELOW, lty = 2)


```

```{r "Started to use Poisson GLM distributions?"}
# Dpark is x -- n_seedlings
#TotN is y -- Openness


BSTEST <- n_seedlings length(position[regen_count>=1])


plot(poolsum$openness, (poolsum$n_seedlings>0), xlab ="Number of Seedlings", ylab = "Canopy Openness")

M1 <- glm(n_seedlings ~ openness, family = gaussian, data = poolsum)
poolsum %>% glm(formula = openness ~ n_seedlings, family = poisson)
summary(M1)

explanatory_data <- poolsum %>% 
    select(openness)

predict(M1, explanatory_data)

residuals(M1)

GEX <- predict(M1, newdata = GT0, type = "link", se= T)
FEX <- exp(GEX$fit)
FSEUP <- exp(GEX$fit + 1.96 * GEX$se.fit)
FSELOW <- exp(GEX$fit - 1.96 * GEX$se.fit)
lines(explanatory_data$openness, FEX, lty=1)


GT0 <- filter(poolsum, n_seedlings >0) 
predict(M1, GT0)


plot(GT0$openness, GT0$n_seedlings, xlab ="Number of Seedlings", ylab = "Canopy Openness") +
lines(GT0$openness, FEX, lty=1) +
lines(GT0$openness, FSEUP, lty = 2) +
  lines(GT0$openness, FSELOW, lty = 2)


```




```{r}
plot(poolsum$openness, poolsum$n_seedlings, xlab ="Number of Seedlings", ylab = "Canopy Openness")

M1 <- glm(n_seedlings ~ openness, family = poisson, data = poolsum)
poolsum %>% glm(formula = openness ~ n_seedlings, family = poisson)
summary(M1)

explanatory_data <- poolsum %>% 
    select(openness)

predict(M1, explanatory_data)

residuals(M1)

GEX <- predict(M1, newdata = GT0, type = "link", se= T)
FEX <- exp(GEX$fit)
FSEUP <- exp(GEX$fit + 1.96 * GEX$se.fit)
FSELOW <- exp(GEX$fit - 1.96 * GEX$se.fit)
lines(GT0$openness, FEX, lty=1)





plot(GT0$openness, GT0$n_seedlings, xlab ="Number of Seedlings", ylab = "Canopy Openness") +
lines(GT0$openness, FEX, lty=1) +
lines(GT0$openness, FSEUP, lty = 2) +
  lines(GT0$openness, FSELOW, lty = 2)
```

