---
title: "Spring'24 Code"
author: "GNyen"
date: "2024-02-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r "Chunk 1 Import data and library packages, set up cluster"}
library(tidyverse)
library(glmmADMB)
library(broom)
library(vegan)
library(parallel)
library(janitor)
detectCores() # counts how many cores the computer has # this is just good to know for the makeCluster() argument

metadata<- read.csv("C:/Users/gn238/Downloads/gn_metadata_wzeros.csv") #this is my meta data from the understory community change over time study
regendata <- read.csv("C:/Users/gn238/OneDrive - Mississippi State University/R - Copy/r_pull_from/regenplots.csv") #here is the meta data on the understory regen. This includes height of trees, metadata does not

clus <- parallel::makeCluster(15) # creates a cluster using 15 of 16 cores

clusterEvalQ(clus, library(vegan)) # allow vegan to use the cluster when running any function

```


```{r "set up regendata averaged by sampling plot"}

regendata <- regendata %>% 
    dplyr::select(-starts_with('X')) %>% #this removes the data columns that didn't contain any information
    clean_names() %>% #this uses janitor to make the names lowercase and better
       separate(col = plot_id,  into = c("stand", "transect", "position")) #this gives a new column for each by separating stand, transect, and position
regendata$standbyrow <- paste(regendata$stand, "_", regendata$row) #this created a new row in regendata for "stand_by_row" a mixture of how does row type and stand interact 
```


```{r "add a seed trt column"}

seed1 <- regendata %>% filter(stand == 6)
seed2 <- regendata %>% filter(stand == 7)
seed3 <- regendata %>% filter(stand == 8)
seed4 <- regendata %>% filter(stand == 9)
trts5 <- bind_rows(seed1,seed2,seed3,seed4)
trts6 <- trts5 %>% add_column(add_column = "S") #all of this created new column with "S" for seeded

unse1 <- regendata %>% filter(stand == 3)
unse2 <- regendata %>% filter(stand == 4)
unse3 <- regendata %>% filter(stand == 5)
unse4 <- regendata %>% filter(stand == 10)
trtu5 <- bind_rows(unse1,unse2,unse3,unse4)
trtu5 <- trtu5 %>% add_column(add_column = "U") #all of this created new column with "U" for unseeded

regendata <- bind_rows(trts6, trtu5) #this mashed the two tables together (U) and (S)
regendata <- rename(regendata, seed_trt = add_column) #this changed the name of the new column to "seed_trt" which now contains a S or a U.

```


```{r} 
regen_summary <- regendata %>% 
  group_by(seed_trt, stand, transect, position, row, quadrat) %>% 
  summarise(n_seedlings  = length(position[regen_count>=1]),
            mean_height = mean(height_cm)) #this creates a new df and makes it averaged by heights and counts per quadrat

regen_summary$standbyrow <- paste(regen_summary$stand, "_", regen_summary$row)
#this created a new row in regen_summary for "stand_by_row" a mixture of how does row type and stand interact 
 
```



```{r "lets get regendata averaged per row"}


STAND_ROW_SUMMARY   <- regen_summary %>% group_by(stand, row, seed_trt) %>% 
            summarise(n_seedlings_mean = mean(n_seedlings),
            n_seedlings_sd = sd(n_seedlings),
            height_mean = mean(mean_height, na.rm = TRUE),
            height_sd = sd(mean_height, na.rm = TRUE)) 
#this is a summary table from regen_summary where each stand has a row type and a seed trt assigned to it. Average heights, and numbers of seedlings alongside SD's are listed in the table. Useful for testing trt effects based on row type
STAND_ROW_SUMMARY


stand_transect_summary  <-regen_summary %>% group_by(stand, transect, row, seed_trt) %>% 
            summarise(n_seedlings_mean = mean(n_seedlings),
            n_seedlings_sd = sd(n_seedlings),
            height_mean = mean(mean_height, na.rm = TRUE),
            height_sd = sd(mean_height, na.rm = TRUE))
stand_transect_summary
 stand_transect_summary$standbyrow <- paste(stand_transect_summary$stand, "_", stand_transect_summary$row)
#this is a summary table from regen_summary where each stand is broken up by transect. Transects had an assigned row type and a seeding treatment. All values had Average heights, and numbers of seedlings alongside SD's are listed in the table.
 
 
 
 
 #lets make a biomass difference table to see if there is a sig diff in biomass between stands/rows
 
 BIOMASS_TRANSECT_SUMMARY   <- trts %>% group_by(stand, row, transect, seed_trt) %>% 
            summarise(biomass_sum_row = mean(biomass_sum),
            biomass_sum_sd = sd(biomass_sum))
 
 head(BIOMASS_TRANSECT_SUMMARY,16)
bio<- lm(biomass_sum_row ~ seed_trt, data=BIOMASS_TRANSECT_SUMMARY)
summary(bio)

Test1<- lm(biomass_sum_row ~ row, data=BIOMASS_TRANSECT_SUMMARY)
summary(Test1)
 #seed treatment had a pvalue of 0.057 for effecting biomass differentials between treatments
 
 BIOMASS_ROW_SUMMARY   <- trts %>% group_by(stand, row, seed_trt) %>% 
            summarise(biomass_sum_row = mean(biomass_sum),
            biomass_sum_sd = sd(biomass_sum))
 
 head(BIOMASS_ROW_SUMMARY,16)
bio2<- lm(biomass_sum_row ~ seed_trt, data=BIOMASS_ROW_SUMMARY)
summary(bio2)

 Test2<- lm(biomass_sum_row ~ row, data=BIOMASS_ROW_SUMMARY)
summary(Test2)

```


```{r}
#This chunk is for stand/transect grouping. So replicates are transects within the stand. Remember that transects are nested within treatment and row type  <- i(jk)



m1 <- aov(n_seedlings_mean ~ seed_trt, data = stand_transect_summary)
summary(m1) #seed treatment has a p value of 0.013  !!!!!!
#We have significant number of seedlings predicted by seed treatment
checkheight <- lm(n_seedlings_mean ~ seed_trt, data=stand_transect_summary)
glance(checkheight) #same as m1 but in lm form !!!!!

m2 <- aov(n_seedlings_mean ~ row, data= stand_transect_summary)
glance(m2) ## not significant
summary(m2)

m3 <- aov(height_mean ~ seed_trt, data = stand_transect_summary)
summary(m3) ## not significant

m4 <- aov(height_mean ~ row, data = stand_transect_summary )
summary(m4) ## not significant

m5 <- aov(n_seedlings_mean ~ stand, data = stand_transect_summary )
summary(m5) # stand is extremely significant in determining mean number of seedlings or mean number of seedlings are greatly impacted by height !!! !!! !!! 


ggplot(stand_transect_summary, aes(
  x = factor(stand, levels = c(3, 4, 5, 10, 6, 7, 8, 9)),
  y = n_seedlings_mean,
  fill = row
)) +   geom_boxplot() + theme_minimal() #this is a ggplot using stand transects as the replicates with mean number of seedlings filled into the boxplot


```



```{r}
#This chunk is for stand/row groupings. So replicates are row types within the stand. Remember that stand is nested within treatment <- i(j)


m1 <- aov(n_seedlings_mean ~ seed_trt, data = STAND_ROW_SUMMARY)
summary(m1) #!!! !!! .0452 p value.
#We have significant number of seedlings predicted by seed treatment
checkheight <- lm(n_seedlings_mean ~ seed_trt, data=STAND_ROW_SUMMARY)
glance(checkheight) #same as m1 but as a linear model

m2 <- aov(n_seedlings ~ standbyrow, data= regen_summary)
glance(m2)
summary(m2)

m3 <- aov(n_seedlings_mean ~ row, data = STAND_ROW_SUMMARY)
summary(m3)

testing<- STAND_ROW_SUMMARY
testing[is.na(testing)] <- 0


m4 <- aov(height_mean ~ row, data = testing )
summary(m4)

head(STAND_ROW_SUMMARY)
m5 <- aov(height_mean ~ row, data = STAND_ROW_SUMMARY)
summary(m5)

ggplot(data=testing, aes( x=row, y= height_mean)) + geom_boxplot() +
  theme_minimal()

ggplot(data=regen_summary, aes(x=stand, y=n_seedlings)) +
  geom_boxplot() +theme_minimal()

ggplot(data=regen_summary, aes(x=standbyrow, y=n_seedlings)) +
  geom_boxplot() +theme_minimal()

ggplot(STAND_ROW_SUMMARY, aes(
  x = factor(stand, levels = c(3, 4, 5, 10, 6, 7, 8, 9)),
  y = n_seedlings_mean,
  fill = row
)) +   geom_boxplot() + theme_minimal()


ggplot(data=STAND_ROW_SUMMARY, aes(x=seed_trt, y=height_mean), na.rm=T) +
  geom_boxplot() + theme_minimal()
```

```{r}
#lets make a glmmADMB model after what Joshua J. Puhlick sent me


metadata<- read.csv("C:/Users/gn238/Downloads/gn_metadata_wzeros.csv", header=T, na.strings="")
#import the metadata, make all empty entries into NA's

metadata <- metadata %>% mutate(species_code = coalesce(species_code, species))
head(metadata, 20)
#replace all blank species with the unknown official names listed in the species_code column

data <-metadata %>% filter(!is.na(species_code))
#get rid of the entries without a species code after the coalesce.

data <- data %>% filter(!plot_id=="9-6-K")
#takes out a plot that didnt have data to it

varibs <- data %>% summarise(plot_id, n_seedlings, openness, lai_2000_lin, ppfd_total_under_per_day_m_jor_mol_m2day, gap_fraction, row, stand, transect) %>%
 distinct()
#create a variable data frame

varibs<- varibs  %>% replace_na(list(plot_id=0, n_seedlings=0, openness=0, lai_2000_lin = 0, ppfd_total_under_per_day_m_jor_mol_m2day = 0, gap_fraction= 0, row = "L", stand=0, standbyrow= 0))
#changes the NA values to be the resting values of zero or in the row it changes to a Leave row


dat1 <- data %>% dplyr::select(plot_id, species_code, dried_weight_g) %>%
  pivot_wider(names_from = species_code, values_from = dried_weight_g, values_fn = sum, values_fill = 0)
#this transforms the data frame into a wide format such that it can be used in NMDS


#add up spp weights to pool for each plot
dat1_long <- dat1 %>% 
  pivot_longer(!plot_id, names_to = "species", values_to = "biomass")

dat1_summary <- dat1_long %>% 
  group_by(plot_id) %>%
  summarise(biomass_sum = sum(biomass))
#add up spp weights to pool for each plot

 dat1_long1 <- dat1_long %>% 
       mutate(species = as.character(species))


dat1_long_noPIPA <- dat1_long1 %>% filter(species != "PIPA")

dat1_summary_noPIPA <- dat1_long_noPIPA %>% 
  group_by(plot_id) %>%
  summarise(biomass_sum = sum(biomass))

#this is a df with species weight on the inside and plot & species as headers
input_dat <- dat1 %>% column_to_rownames("plot_id")
#this is a df with species weight on the inside and plot & species as headers



  #plot side/axis 1 and 2 of 3D figure
  
  ### This is to add a seeding treatment to trts by way of using varibs in the chain ###

seeded6 <- varibs %>% filter(stand == 6)
seeded7 <- varibs %>% filter(stand == 7)
seeded8 <- varibs %>% filter(stand == 8)
seeded9 <- varibs %>% filter(stand == 9)
trtseed <- bind_rows(seeded6,seeded7,seeded8,seeded9)
trtseed <- trtseed %>% add_column(add_column = "S")

unseed3 <- varibs %>% filter(stand == 3)
unseed4 <- varibs %>% filter(stand == 4)
unseed5 <- varibs %>% filter(stand == 5)
unseed10 <- varibs %>% filter(stand == 10)
trtunseed <- bind_rows(unseed3,unseed4,unseed5,unseed10)
trtunseed <- trtunseed %>% add_column(add_column = "U")

trts <- bind_rows(trtseed,trtunseed)

trts <- trts  %>% 
  filter(!is.na(row))

trts <- rename(trts, seed_trt = add_column)
trtsNP <- trts %>% left_join(dat1_summary_noPIPA, by= "plot_id") %>% column_to_rownames("plot_id")
# trtsNP is now the data frame to work off for models. It has biomass of all species except PIPA included
trts <- trts %>% left_join(dat1_summary, by = "plot_id")
trts <- trts %>% column_to_rownames("plot_id")

trts$standbyrow <- paste(trts$stand, "_", trts$row)
trtsNP$standbyrow <- paste(trtsNP$stand, "_", trtsNP$row)
  ### This is to add a seeding treatment to trts by way of using varibs in the chain ###

trtsNP$binary<- with(trtsNP, ifelse(n_seedlings > 0, '1', '0')) %>% as.numeric()
trtsNP$stand <- as.factor(trtsNP$stand)
trtsNP$seed_trt <- as.factor(trtsNP$seed_trt)
trtsNP$row <- as.factor(trtsNP$row)

```

```{r}
library(glmmADMB)


#this is a model that josh sent me

fit_binary <- glmmadmb(binary ~ biomass_sum,
 random = ~1 | stand/row, family='binomial', link='cloglog',
 data=trtsNP)
summary(fit_binary) ### fit_binary has a significant factor of biomass_sum
print(fit_binary)

#this is a model that josh sent me

fit_binary2 <- glmmadmb(binary ~ seed_trt,
  random = ~1 | stand/row, family='binomial', link='cloglog',
  data=trtsNP)

summary(fit_binary)

# this is another model from Josh
fit_hpoiss <- glmmadmb(n_seedlings ~ biomass_sum+ppfd_total_under_per_day_m_jor_mol_m2day+ seed_trt,
  random = ~1 | stand/row,
  data = subset(trtsNP, n_seedlings > 0),
  family = "truncpoiss")
 
summary(fit_hpoiss)


#This actually has a lower AIC##
fit_hpoiss2 <- glmmadmb(n_seedlings ~ biomass_sum*ppfd_total_under_per_day_m_jor_mol_m2day + seed_trt,
  random = ~1 | stand/row,
  data = subset(trtsNP, n_seedlings > 0),
  family = "truncpoiss")
 
summary(fit_hpoiss2)




```





```{r "This makes a AIC table and orders them based on the lowest AIC"}


finalmodlist <- list(fit_binary,fit_binary2, fit_hpoiss, fit_hpoiss2) # within the list() place the model call.names/ matrix names 
aictable<- data.frame("Model" = rep(" ",times=length(finalmodlist)),"AIC" = rep(NA,times=length(finalmodlist)))
for(i in 1:length(finalmodlist)){
  aictable$Model[i] <- as.character(finalmodlist[[i]]$formula)[3]
  aictable$AIC[[i]]<- summary(finalmodlist[[i]])$aic[1]
   aictable$nll[i] <- finalmodlist[[i]]$loglik
} #this created a shell and a loop (I don't fully comprehend loops)
orderedAICtablet <- aictable[order(aictable$AIC),] #this orders the aic table by AIC
orderedAICtablet$deltaAIC <- orderedAICtablet$AIC - orderedAICtablet$AIC[1] #this adds a delta AIC
orderedAICtablet$rll <- exp(-0.5*orderedAICtablet$deltaAIC) # this adds a rll value
orderedAICtablet$weight <- orderedAICtablet$rll/sum(orderedAICtablet$rll) #this adds weight
orderedAICtablet$weight <- round(orderedAICtablet$weight,3)  #this changes the weights to be rounded to 3 sig figs.
# write.csv(orderedAICtable_finalset, file = "AICtable_finalset.csv") #this writes the AIC Table into a CSV


```



```{r}

#check if there is a significant weight difference between row types




```



```{r "Vegitables", cache=TRUE}
#vegan analysis

nmdsE <- metaMDS(comm = input_dat,
             autotransform = FALSE,
             distance = "bray",
             engine = "monoMDS",
             k = 3,
             parallel = clus,
             weakties = TRUE,
             model = "global",
             maxit = 5000,
             try = 5000,
             trymax = 5000)

nmdsE$stress
plot(nmdsE)

ef <- envfit(nmdsE ~ lai_2000_lin, trts, permutations = 99999, choices = 1:2, na.rm=T, iterations = 1000)




ordiplot(nmdsE,type="n") #Ordination plot function especially for congested plots
orditorp(nmdsE,display="species",col="red",air=0.01) #The function adds text or points to ordination plots
orditorp(nmdsE,display="sites",cex=0.25,air=0.01)
ef

vegan3d::ordiplot3d(nmdsE, display="sites", choices = 1:3)
```

```{r}

ef <- envfit(nmdsE ~ lai_2000_lin, trts, permutations = 99999, choices = 1:3, na.rm=T, iterations = 1000)
ef

ef1 <- envfit(nmdsE ~ stand, trts, permutations = 99999, choices = 1:3, na.rm = T, iterations= 1000)
ef1

ef2 <- envfit(nmdsE ~ n_seedlings, trts, permutations = 99999, choices = 1:3, na.rm = T, iterations= 1000)
ef2

ef3 <- envfit(nmdsE ~ seed_trt, trts, permutations = 99999, choices = 1:3, na.rm = T, iterations= 1000)
ef3

ef4 <- envfit(nmdsE ~ ppfd_total_under_per_day_m_jor_mol_m2day, trts, permutations = 99999, choices = 1:3, na.rm = T, iterations= 1000)
ef4

ef5 <- envfit(nmdsE ~ openness, trts, permutations = 99999, choices = 1:3, na.rm = T, iterations= 1000)
ef5

ef6 <- envfit(nmdsE ~ gap_fraction, trts, permutations = 99999, choices = 1:3, na.rm = T, iterations= 1000)
ef6

ef7 <- envfit(nmdsE ~ biomass_sum, trts, permutations = 99999, choices = 1:3, na.rm = T, iterations= 1000)
ef7

ef8 <- envfit(nmdsE ~ row, trts, permutations = 99999, choices = 1:3, na.rm = T, iterations= 1000)
ef8

f <-tibble(ef$vectors$arrows[1:3]) %>% rename(lai_2000_lin= "ef$vectors$arrows[1:3]")
f1<-tibble(ef1$vectors$arrows[1:3]) %>% rename(stand= "ef1$vectors$arrows[1:3]")
f2<-tibble(ef2$vectors$arrows[1:3]) %>% rename(n_seedlings= "ef2$vectors$arrows[1:3]")
#f3<-tibble(ef3$vectors$arrows[1:3]) %>% rename(seed_trt= "ef3$vectors$arrows[1:3]")
f4<-tibble(ef4$vectors$arrows[1:3]) %>% 
  rename(ppfd_total_under_per_day_m_jor_mol_m2day= "ef4$vectors$arrows[1:3]")
f5<-tibble(ef5$vectors$arrows[1:3]) %>% rename(openness= "ef5$vectors$arrows[1:3]")
f6<-tibble(ef6$vectors$arrows[1:3]) %>% rename(gap_fraction= "ef6$vectors$arrows[1:3]")
f7<-tibble(ef7$vectors$arrows[1:3]) %>% rename(biomass_sum= "ef7$vectors$arrows[1:3]")
#f8<-tibble(ef8[["factors"]][["centroids"]]) %>% rename(row= ef8[["factors"]][["centroids"]])


flist <- bind_cols(f,f1,f2,f4,f5,f6,f7) %>% as.data.frame()
   rownames(flist) = c("NMDS1", 
                                 "NMDS2",
                                "NMDS3")
flist

rank_flist<-abs(flist)
max(rank_flist[1,]) # Stand is most highly corelated with NMDS1
max(rank_flist[2,]) # n_seedlings is most highly corelated with NMDS2
max(rank_flist[3,]) # biomass_sum is most highly corelated with NMDS3


write.csv(flist, "C:/Users/gn238/Downloads/vector_associations.csv", row.names=T)

```
```{r}

ef_flat<-envfit(nmdsE ~ lai_2000_lin, trts, permutations = 99999, choices = 1:2, na.rm=T, iterations = 1000)
ef_flat

summary(ef_flat)
summary(ef2)

nmdsE

n = 10
stress <- vector(length = n)
for (i in 1:n) {
    stress[i] <- metaMDS(input_dat, distance = "bray", k = i)$stress
}
names(stress) <- paste0(1:n, "Dim")
# x11(width = 10/2.54, height = 7/2.54)
par(mar = c(3.5,3.5,1,1), mgp = c(2, 0.6, 0), cex = 0.8, las = 2)
barplot(stress, ylab = "stress")

```


```{r}
#plot some CCAs or RDAs

ord<- cca(input_dat ~ n_seedlings + biomass_sum + stand, data=trtsNP)
ord

plot(ord)
anova.cca(ord)
anova(ord, by="term", permutations = 199)
anova(ord, by="axis", permutations = 199)

ord2<- cca(input_dat ~ biomass_sum + stand, data=trtsNP)
ord2

anova.cca(ord2)
anova(ord2, by = "term", permutations = 199)

anova(ord, ord2)
summary(anova(ord, ord2))

```

